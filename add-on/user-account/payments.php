<?phpfunction mail_error_payment_rcl($hash=false){	global $rmag_options,$post;		foreach($_REQUEST as $key=>$R){		$textmail .= $key.' - '.$R.'<br>';	}		if($hash){		$textmail .= 'Cформированный хеш - '.$hash.'<br>';		$title = 'Неудачная оплата';	}else{		$title = 'Данные тестового платежа';	}		$textmail .= 'Текущий пост - '.$post->ID.'<br>';	$textmail .= 'RESULT - '.$rmag_options['page_result_pay'].'<br>';	$textmail .= 'SUCCESS - '.$rmag_options['page_success_pay'].'<br>';		$email = $rmag_options['admin_email_magazin_recall'];	if(!$email) $email = get_user_meta( 1, 'user_email', true );		add_filter('wp_mail_content_type',create_function('', 'return "text/html";'));	$headers = 'From: '.get_bloginfo('name').' <noreply@'.$_SERVER['HTTP_HOST'].'>' . "\r\n";						wp_mail($email, $title, $textmail, $headers);				if($hash) exit();}function mail_success_payment_rcl($inv_id,$user_id,$table_order){	global $rmag_options;		//Отправляем письмо об оплате админам	$args = array(		'role' => 'administrator'	);	$users = get_users( $args );	add_filter('wp_mail_content_type',create_function('', 'return "text/html";'));	$headers = 'From: '.get_bloginfo('name').' <noreply@'.$_SERVER['HTTP_HOST'].'>' . "\r\n";	$subject = 'Заказ №'.$inv_id.' оплачен!';					$textmail = '	<p>Пользователь оплатил заказ в магазине "'.get_bloginfo('name').'"</p>	<h3>Информация о покупателе:</h3>	<p><b>Имя</b>: '.get_the_author_meta('display_name',$user_id).'</p>	<p><b>Email</b>: '.get_the_author_meta('user_email',$user_id).'</p>	<h3>Детали заказа:</h3>	'.$table_order.'	<p>Заказ №'.$inv_id.' получил статус "Оплачено".</p>	<p>Ссылка для управления заказом в админке:</p>  	<p>'.get_bloginfo('wpurl').'/wp-admin/admin.php?page=manage-rmag&order='.$inv_id.'</p>';		$admin_email = $rmag_options['admin_email_magazin_recall'];	if($admin_email){		wp_mail($admin_email, $subject, $textmail, $headers);	}else{		foreach((array)$users as $userdata){			$email = $userdata->user_email;												wp_mail($email, $subject, $textmail, $headers);		}	}		//Отправляем письмо об оплате покупателю	$email = get_the_author_meta('user_email',$user_id);					$textmail = '	<p>Вы оплатили заказ в магазине "'.get_bloginfo('name').'"</p>	<h3>Информация о покупателе:</h3>	<p><b>Имя</b>: '.get_the_author_meta('display_name',$user_id).'</p>	<p><b>Email</b>: '.get_the_author_meta('user_email',$user_id).'</p>	<p>Заказ №'.$inv_id.' получил статус "Оплачено".</p>	<p>Ваш заказ оплачен и поступил в обработку. Вы можете следить за сменой его статуса из своего личного кабинета</p>  	<p>Это письмо было создано автоматически, не надо отвечать на него</p>';					wp_mail($email, $subject, $textmail, $headers);}function payments_request_recall_magazine(){	global $post;	global $wpdb;	global $rmag_options;		$type_order_payment = $rmag_options['type_order_payment']; 	if($post->ID==$rmag_options['page_result_pay']){			if($rmag_options['connect_sale']==1){ //если используется робокасса			$time_action = current_time('mysql');			$mrh_pass2 = $rmag_options['tworobopass'];			$out_summ = $_REQUEST["OutSum"];			$inv_id = $_REQUEST["InvId"];			$shp_item = $_REQUEST["Shp_item"];			$crc = $_REQUEST["SignatureValue"];			$user_ID = $_REQUEST["shpa"];			$shpb = $_REQUEST["shpb"]; //тип платежа. 1 - пополнение личного счета, 2 - оплата заказа			$crc = strtoupper($crc);			$my_crc = strtoupper(md5("$out_summ:$inv_id:$mrh_pass2:Shp_item=$shp_item:shpa=$user_ID:shpb=$shpb"));			if ($my_crc !=$crc) mail_error_payment_rcl($my_crc);						$pay = $wpdb->get_row("SELECT * FROM ".RMAG_PREF ."pay_results WHERE inv_id = '$inv_id' AND user = '$user_ID'");						if($pay){				if($shpb==1) exit();				$add_cashe = true;				}else{				$results = $wpdb->insert( RMAG_PREF .'pay_results', 						array( 'inv_id' => "$inv_id", 'user' => "$user_ID", 'count' => "$out_summ", 'time_action' => "$time_action" )						);										$add_cashe = true;							}						if($add_cashe&&$shpb==1){								$oldusercount = $wpdb->get_row("SELECT * FROM ".RMAG_PREF ."user_count WHERE user='$user_ID'");				if($oldusercount){					$newusercount = "$oldusercount->count" + $out_summ;								$wpdb->update( RMAG_PREF .'user_count', 								array( 'count' => "$newusercount" ),								array( 'user' => "$user_ID" )								);				}else{					$wpdb->insert( RMAG_PREF .'user_count', 								array( 'user' => "$user_ID", 'count' => $out_summ )								);				}				do_action('payment_payservice_rcl',$user_ID,$out_summ,'Пополнение личного счета',2);								//echo "OK$inv_id\n";			}						if($add_cashe&&$shpb==2){												$wpdb->update( RMAG_PREF ."orders_history", 					array( 'status' => 2 ),					array( 'inv_id' => $inv_id)				);								do_action('payment_payservice_rcl',$user_ID,$out_summ,'Оплата заказа '.$inv_id,1);								//Если работает реферальная система и партнеру начисляются проценты с покупок его реферала				if(function_exists('add_referall_incentive_order')) 					add_referall_incentive_order($user_ID,$out_summ);									$order_data = $wpdb->get_results("SELECT * FROM ".RMAG_PREF ."orders_history WHERE inv_id = '$inv_id'");				$table_order = get_email_table_order_rcl($order_data,$inv_id,$out_summ);								mail_success_payment_rcl($inv_id,$user_ID,$table_order);								echo "OK$inv_id\n";			}						if(!$pay) do_action('payment_rcl',$user_ID,$out_summ,$inv_id);		}				if($rmag_options['connect_sale']==2){ //если используется интеркасса			//mail_error_payment_rcl();			$time_action = current_time('mysql');			$ik_payment_amount = $_REQUEST["ik_am"];			$ik_payment_id = $_REQUEST["ik_pm_no"];									$ik_baggage_fields = $_REQUEST["ik_x_user_id"];			$type_pay = $_REQUEST["ik_x_type"];						foreach ($_POST as $key => $value) {				if (!preg_match('/ik_/', $key)) continue;				$data[$key] = $value;			}			$ikSign = $data['ik_sign'];			unset($data['ik_sign']);			if ($data['ik_pw_via'] == 'test_interkassa_test_xts') {				$secret_key = $rmag_options['intertestkey'];			} else {				$secret_key = $rmag_options['intersecretkey'];			}			ksort ($data, SORT_STRING);			array_push($data, $secret_key);			$signStr = implode(':', $data);			$sign = base64_encode(md5($signStr, true));										if ($sign !=$ikSign) mail_error_payment_rcl($sign);						$pay = $wpdb->get_row("SELECT * FROM ".RMAG_PREF ."pay_results WHERE inv_id = '$ik_payment_id' AND user = '$ik_baggage_fields'");						if(!$pay){								if($type_pay==2){									$order_true = $wpdb->get_row("SELECT * FROM ".RMAG_PREF ."orders_history WHERE inv_id = '$ik_payment_id' AND status = '1'");													if($order_true){											$wpdb->update( RMAG_PREF ."orders_history", 							array( 'status' => 2 ),							array( 'inv_id' => $ik_payment_id)						);												do_action('payment_payservice_rcl',$ik_baggage_fields,$ik_payment_amount,'Оплата заказа '.$ik_payment_id,1);												//Если работает реферальная система и партнеру начисляются проценты с покупок его реферала						if(function_exists('add_referall_incentive_order')) 							add_referall_incentive_order($ik_baggage_fields,$ik_payment_amount);													$order_data = $wpdb->get_results("SELECT * FROM ".RMAG_PREF ."orders_history WHERE inv_id = '$ik_payment_id'");						$table_order = get_email_table_order_rcl($order_data,$ik_payment_id,$ik_payment_amount);												$args = array(						'role' => 'administrator'						);						$users = get_users( $args );												mail_success_payment_rcl($ik_payment_id,$ik_baggage_fields,$table_order);					}				}								if($type_pay==1){										$results = $wpdb->insert( RMAG_PREF .'pay_results', 							array( 'inv_id' => "$ik_payment_id", 'user' => "$ik_baggage_fields", 'count' => "$ik_payment_amount", 'time_action' => "$time_action" )						);											$oldusercount = $wpdb->get_row("SELECT * FROM ".RMAG_PREF ."user_count WHERE user='$ik_baggage_fields'");						if($oldusercount){							$newusercount = "$oldusercount->count" + $ik_payment_amount;										$wpdb->update( RMAG_PREF .'user_count', 										array( 'count' => "$newusercount" ),										array( 'user' => "$ik_baggage_fields" )										);					}else{						$wpdb->insert( RMAG_PREF .'user_count', 									array( 'user' => "$ik_baggage_fields", 'count' => $ik_payment_amount )									);					}					do_action('payment_payservice_rcl',$ik_baggage_fields,$ik_payment_amount,'Пополнение личного счета',2);				}				do_action('payment_rcl',$ik_baggage_fields,$ik_payment_amount,$ik_payment_id);			}		}	}			if($post->ID==$rmag_options['page_success_pay']){			if($rmag_options['connect_sale']==1){ //если используется робокасса				$inv_id = $_REQUEST["InvId"];			$user_ID = $_REQUEST["shpa"];		}				if($rmag_options['connect_sale']==2){ //если используется Интеркасса				$inv_id = $_REQUEST["ik_pm_no"];				$user_ID = $_REQUEST["ik_x_user_id"];		}			$results = $wpdb->get_row("SELECT * FROM ".RMAG_PREF ."pay_results WHERE user='$user_ID' AND inv_id='$inv_id'");					if($results){			wp_redirect(get_permalink($rmag_options['page_successfully_pay'])); exit;				} else {			wp_die('Запись о платеже в базе данных не найдена');		}	}}function payments_request_recall_magazine_activate(){	  if (isset($_REQUEST["InvId"])||isset($_REQUEST["ik_co_id"])){    add_action( 'wp', 'payments_request_recall_magazine' );  }}add_action('init', 'payments_request_recall_magazine_activate');?>